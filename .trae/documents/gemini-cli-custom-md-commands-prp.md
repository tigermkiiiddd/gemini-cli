# Gemini CLI 自定义 Markdown 命令功能扩展 - 项目规划文档 (PRP)

## 1. 项目概述

### 1.1 项目背景
当前 Gemini CLI 已支持基于 TOML 格式的自定义命令系统，用户可以在 `.gemini/commands/` 目录下创建 `.toml` 文件定义自定义命令。为了提升用户体验和降低使用门槛，需要扩展支持 Markdown 格式的自定义命令定义。

### 1.2 项目目标
- 扩展现有命令系统，支持 `.md` 文件格式的自定义命令
- 保持与现有 TOML 命令系统的兼容性
- 提供更直观的自然语言命令定义方式
- 支持参数替换和备注信息读取

### 1.3 项目价值
- **降低使用门槛**：Markdown 格式比 TOML 更易于编写和理解
- **提升开发效率**：减少重复输入相同的提示文本
- **增强团队协作**：便于团队共享和维护命令模板

## 2. 分析路径

### 2.1 现状分析

#### 2.1.1 现有技术架构
- **命令系统**：基于 TOML 文件的自定义命令
- **文件结构**：`.gemini/commands/` 目录存放命令文件
- **触发方式**：`/` + 命令名的方式调用
- **参数处理**：支持参数替换和模板渲染

#### 2.1.2 技术栈分析
- **语言**：TypeScript/Node.js
- **配置解析**：当前使用 TOML 解析器
- **命令处理**：集成在主要的命令处理流程中
- **文件监控**：支持动态加载命令文件

#### 2.1.3 用户需求分析
- **易用性**：希望使用更直观的 Markdown 格式
- **兼容性**：不影响现有 TOML 命令的使用
- **功能性**：支持参数替换和备注信息
- **扩展性**：便于后续功能扩展

### 2.2 技术可行性分析

#### 2.2.1 优势
- 现有命令系统架构良好，易于扩展
- TypeScript 生态系统有成熟的 Markdown 解析库
- 文件扫描和注册机制已经存在

#### 2.2.2 挑战
- 需要设计合适的 Markdown 格式规范
- 保持与现有系统的兼容性
- 处理 Markdown 中的元数据提取

#### 2.2.3 风险评估
- **低风险**：基于现有架构扩展，不涉及核心逻辑重构
- **兼容性风险**：需确保不影响现有 TOML 命令
- **性能风险**：Markdown 解析可能略慢于 TOML，但影响微小

## 3. 实施路径

### 3.1 开发阶段规划

#### 阶段一：需求分析与设计 (1-2天)
- [ ] 深入分析现有命令系统代码结构
- [ ] 设计 Markdown 命令文件格式规范
- [ ] 制定技术实现方案
- [ ] 确定测试策略

#### 阶段二：核心功能开发 (3-5天)
- [ ] 实现 Markdown 文件解析器
- [ ] 扩展命令发现和注册机制
- [ ] 集成到现有命令执行流程
- [ ] 实现参数替换功能

#### 阶段三：测试与优化 (2-3天)
- [ ] 编写单元测试
- [ ] 进行集成测试
- [ ] 性能优化
- [ ] 兼容性验证

#### 阶段四：文档与发布 (1-2天)
- [ ] 编写用户文档
- [ ] 更新 README 和示例
- [ ] 准备发布说明

### 3.2 技术实施计划

#### 3.2.1 文件格式设计
```markdown
---
name: "命令名称"
description: "命令描述"
args: ["参数1", "参数2"]
---

这里是命令的提示模板内容。
可以使用 {{args}} 来引用用户输入的参数。
可以使用 {{arg1}} 来引用特定位置的参数。
```

#### 3.2.2 核心模块设计
1. **MarkdownCommandParser**：解析 .md 文件
2. **CommandRegistry**：扩展现有注册机制
3. **TemplateRenderer**：处理参数替换
4. **FileWatcher**：监控文件变化

#### 3.2.3 集成点识别
- 命令发现机制：扩展文件扫描逻辑
- 命令解析器：添加 Markdown 解析分支
- 命令执行器：统一处理 TOML 和 MD 命令

### 3.3 实施优先级

#### 高优先级
1. Markdown 文件解析功能
2. 基本的参数替换
3. 与现有系统的集成

#### 中优先级
1. 高级参数处理功能
2. 错误处理和用户提示
3. 性能优化

#### 低优先级
1. 高级模板功能
2. 命令文档生成
3. IDE 集成支持

### 3.4 成功标准

#### 功能标准
- [ ] 支持 .md 格式的自定义命令定义
- [ ] 保持与现有 TOML 命令的完全兼容
- [ ] 支持参数替换和模板渲染
- [ ] 提供清晰的错误提示

#### 质量标准
- [ ] 代码覆盖率 > 80%
- [ ] 所有现有测试通过
- [ ] 性能影响 < 10%
- [ ] 文档完整且准确

#### 用户体验标准
- [ ] 命令创建简单直观
- [ ] 错误信息清晰易懂
- [ ] 与现有工作流程无缝集成

## 4. 资源需求

### 4.1 人力资源
- **开发工程师**：1人，负责核心功能开发
- **测试工程师**：0.5人，负责测试用例编写和验证
- **技术文档**：0.5人，负责文档编写和维护

### 4.2 技术资源
- **开发环境**：Node.js + TypeScript 开发环境
- **依赖库**：Markdown 解析库（如 gray-matter, marked）
- **测试工具**：现有的测试框架和工具

### 4.3 时间资源
- **总开发时间**：7-12 个工作日
- **测试时间**：3-5 个工作日
- **文档时间**：2-3 个工作日

## 5. 风险管控

### 5.1 技术风险
- **风险**：Markdown 解析复杂度超预期
- **缓解**：选择成熟的解析库，制定简单的格式规范

### 5.2 兼容性风险
- **风险**：影响现有 TOML 命令功能
- **缓解**：充分的回归测试，渐进式集成

### 5.3 用户接受度风险
- **风险**：用户不习惯新的命令格式
- **缓解**：提供详细文档和示例，保持向后兼容

## 6. 后续规划

### 6.1 短期规划 (1-3个月)
- 收集用户反馈，优化功能
- 添加更多模板功能
- 改进错误处理

### 6.2 长期规划 (3-12个月)
- 支持命令组织和分类
- 集成 IDE 插件支持
- 添加命令市场功能